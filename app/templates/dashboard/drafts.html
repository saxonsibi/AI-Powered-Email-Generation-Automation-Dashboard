{% extends "base.html" %}

{% block title %}Drafts - AI Email Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto h-screen flex flex-col">
    <div class="flex items-center justify-between mb-6 pb-4">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Drafts</h1>
        <div class="flex items-center space-x-4">
            <button id="refreshBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-sync-alt mr-2"></i>
                Refresh
            </button>
            <a href="{{ url_for('main.compose') }}" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-edit mr-2"></i>
                Compose
            </a>
        </div>
    </div>
    
    <!-- Search and Filter Bar -->
    <div class="glass rounded-xl p-4 mb-6 neumorphic">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
            <div class="flex-1 max-w-lg">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <form id="searchForm" method="GET" action="{{ url_for('main.drafts') }}" class="w-full">
                        <input type="text" name="search" value="{{ search or '' }}" class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Search drafts...">
                    </form>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <select name="page_size" id="pageSize" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="10" {% if page_size == 10 %}selected{% endif %}>10 per page</option>
                    <option value="20" {% if page_size == 20 %}selected{% endif %}>20 per page</option>
                    <option value="50" {% if page_size == 50 %}selected{% endif %}>50 per page</option>
                </select>
                <button id="filterBtn" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <i class="fas fa-filter mr-2"></i>Filter
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="loadingIndicator" class="flex justify-center items-center py-8 hidden">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        <span class="ml-2 text-gray-600 dark:text-gray-400">Loading drafts...</span>
    </div>
    
    <!-- Error message -->
    <div id="errorMessage" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md p-4 mb-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-400"></i>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error loading drafts</h3>
                <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                    <p id="errorText">There was an error loading your drafts. Please try again.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Drafts List -->
    <div id="draftsContainer" class="glass rounded-xl neumorphic flex-1 flex flex-col">
        <div class="overflow-y-auto flex-1">
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {% if drafts and drafts|length > 0 %}
                    {% for draft in drafts %}
                    <div class="draft-row flex items-center px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150 cursor-pointer" data-draft-id="{{ draft.id }}" onclick="viewDraft({{ draft.id }})">
                        <!-- Store draft data as JSON in data attributes -->
                        <div id="draft-data-{{ draft.id }}" 
                             data-id="{{ draft.id }}" 
                             data-subject="{{ draft.subject or '' }}" 
                             data-recipients="{{ draft.to or '' }}" 
                             data-body="{{ draft.body|replace('"', '&quot;')|replace('\n', '\\n') if draft.body else '' }}" 
                             data-updated-at="{{ draft.updated_at.strftime('%b %d, %Y %I:%M %p') if draft.updated_at else '' }}"
                             data-attachments="{{ draft.attachments.count() if draft.attachments else 0 }}"
                             style="display: none;"></div>
                        
                        <div class="flex items-center space-x-3 w-full">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                                    <i class="fas fa-file-alt text-gray-500 dark:text-gray-400"></i>
                                </div>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1 pr-4">
                                        <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                            {% if draft.subject %}
                                                {{ draft.subject }}
                                            {% else %}
                                                (No Subject)
                                            {% endif %}
                                        </p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 truncate">
                                            {{ draft.to }}
                                        </p>
                                    </div>
                                    
                                    <!-- Centered three dots menu -->
                                    <div class="flex items-center justify-center flex-shrink-0 mx-4">
                                        <div class="relative inline-block text-left" style="z-index: 50;">
                                            <button type="button" class="inline-flex justify-center w-full rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-2 py-1 bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" id="options-menu-{{ draft.id }}" aria-expanded="false" aria-haspopup="true" onclick="event.stopPropagation(); toggleDraftDropdown(event, {{ draft.id }})">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            
                                            <!-- Dropdown panel with fixed positioning above the button -->
                                            <div id="draft-dropdown-{{ draft.id }}" class="hidden origin-top-right absolute right-0 top-full mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 dark:divide-gray-700 focus:outline-none" style="z-index: 9999;" role="menu" aria-orientation="vertical" aria-labelledby="options-menu-{{ draft.id }}">
                                                <div class="py-1" role="none">
                                                    <button onclick="event.stopPropagation(); editDraft({{ draft.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                                        <i class="fas fa-edit mr-2"></i> Edit
                                                    </button>
                                                    <button onclick="event.stopPropagation(); duplicateDraft({{ draft.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                                        <i class="fas fa-copy mr-2"></i> Duplicate
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteDraft({{ draft.id }})" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700" role="menuitem">
                                                        <i class="fas fa-trash mr-2"></i> Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 flex-shrink-0">
                                        <span class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">
                                            {{ draft.updated_at.strftime('%b %d, %Y %I:%M %p') if draft.updated_at else '' }}
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2 mt-1">
                                    {{ draft.body|striptags|truncate(150) if draft.body else '' }}
                                </div>
                                
                                {% set attachment_count = draft.attachments.count() %}
                                {% if attachment_count > 0 %}
                                <div class="mt-2 flex items-center space-x-2">
                                    <i class="fas fa-paperclip text-gray-400"></i>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                        {{ attachment_count }} attachment{{ 's' if attachment_count != 1 else '' }}
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-file-alt text-5xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No drafts</h3>
                    <p class="text-gray-500 dark:text-gray-400">
                        You don't have any saved drafts.
                    </p>
                    <a href="{{ url_for('main.compose') }}" 
                       class="mt-4 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-edit mr-2"></i>
                        Compose Email
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Pagination -->
        {% if pagination and (pagination.has_next or pagination.has_prev) %}
        <div class="bg-white dark:bg-gray-800 px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if pagination.has_prev %}
                <a href="{{ url_for('main.drafts', page_token=pagination.prev_page_token, page_size=page_size, search=search) }}" 
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                    Previous
                </a>
                {% endif %}
                {% if pagination.has_next %}
                <a href="{{ url_for('main.drafts', page_token=pagination.next_page_token, page_size=page_size, search=search) }}" 
                   class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                    Next
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        Showing
                        <span class="font-medium">{{ pagination.start_index or 1 }}</span>
                        to
                        <span class="font-medium">{{ pagination.end_index or drafts|length }}</span>
                        of
                        <span class="font-medium">{{ total_count }}</span>
                        results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if pagination.has_prev %}
                        <a href="{{ url_for('main.drafts', page_token=pagination.prev_page_token, page_size=page_size, search=search) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                            <span class="sr-only">Previous</span>
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600">
                            {{ pagination.current_page or 1 }}
                        </span>
                        {% if pagination.has_next %}
                        <a href="{{ url_for('main.drafts', page_token=pagination.next_page_token, page_size=page_size, search=search) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                            <span class="sr-only">Next</span>
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Draft View Modal -->
<div id="draftModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="modalSubject">Draft Subject</h3>
            <button onclick="closeDraftModal()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="px-6 py-4 overflow-y-auto flex-1">
            <div class="mb-4">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To:</p>
                <p class="text-sm text-gray-900 dark:text-white" id="modalRecipients">Recipients</p>
            </div>
            <div class="mb-4">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date:</p>
                <p class="text-sm text-gray-900 dark:text-white" id="modalDate">Date</p>
            </div>
            <div class="mb-4" id="modalAttachmentsContainer" style="display: none;">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attachments:</p>
                <div id="modalAttachments" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Message:</p>
                <div class="text-sm text-gray-900 dark:text-white whitespace-pre-wrap" id="modalBody">Draft body</div>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
            <button onclick="closeDraftModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Close
            </button>
            <button id="modalEditBtn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-edit mr-2"></i>
                Edit
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // GSAP animations
    if (typeof gsap !== 'undefined') {
        gsap.from(".draft-row", {
            duration: 0.5,
            x: -20,
            opacity: 0,
            stagger: 0.05,
            ease: "power2.out"
        });
    }
    
    // Page size change handler
    const pageSizeSelect = document.getElementById('pageSize');
    if (pageSizeSelect) {
        pageSizeSelect.addEventListener('change', function() {
            const pageSize = this.value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('page_size', pageSize);
            window.location.href = currentUrl.toString();
        });
    }
    
    // Refresh functionality
    document.getElementById('refreshBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        fetch('/api/refresh-drafts', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            icon.classList.remove('fa-spin');
            if (data.success) {
                showToast('Drafts refreshed successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Failed to refresh drafts', 'error');
            }
        })
        .catch(error => {
            icon.classList.remove('fa-spin');
            showToast('Error refreshing drafts', 'error');
        });
    });
});

function toggleDraftDropdown(event, draftId) {
    event.stopPropagation();
    
    const dropdown = document.getElementById(`draft-dropdown-${draftId}`);
    const button = document.getElementById(`options-menu-${draftId}`);
    
    // Close all other dropdowns
    document.querySelectorAll('[id^="draft-dropdown-"]').forEach(d => {
        if (d.id !== `draft-dropdown-${draftId}`) {
            d.classList.add('hidden');
            // Reset aria-expanded for other buttons
            const otherButtonId = d.id.replace('draft-dropdown-', 'options-menu-');
            const otherButton = document.getElementById(otherButtonId);
            if (otherButton) {
                otherButton.setAttribute('aria-expanded', 'false');
            }
        }
    });
    
    // Toggle current dropdown
    const isHidden = dropdown.classList.contains('hidden');
    if (isHidden) {
        dropdown.classList.remove('hidden');
        button.setAttribute('aria-expanded', 'true');
    } else {
        dropdown.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
    }
}

function viewDraft(draftId) {
    // Get draft data from the data attributes
    const draftDataElement = document.getElementById(`draft-data-${draftId}`);
    
    if (!draftDataElement) {
        showToast('Draft data not found', 'error');
        return;
    }
    
    // Extract data from the data attributes
    const draft = {
        id: draftDataElement.getAttribute('data-id'),
        subject: draftDataElement.getAttribute('data-subject'),
        recipients: draftDataElement.getAttribute('data-recipients'),
        body: draftDataElement.getAttribute('data-body'),
        updated_at: draftDataElement.getAttribute('data-updated-at'),
        attachments: draftDataElement.getAttribute('data-attachments')
    };
    
    // Populate modal with draft data
    document.getElementById('modalSubject').textContent = draft.subject || '(No Subject)';
    document.getElementById('modalRecipients').textContent = draft.recipients || '';
    document.getElementById('modalDate').textContent = draft.updated_at || '';
    
    // Unescape the body text and display it
    const bodyText = draft.body ? draft.body.replace(/\\n/g, '\n').replace(/&quot;/g, '"') : '';
    document.getElementById('modalBody').innerHTML = bodyText;
    
    // Handle attachments
    const attachmentsContainer = document.getElementById('modalAttachmentsContainer');
    const attachmentsDiv = document.getElementById('modalAttachments');
    
    if (draft.attachments > 0) {
        attachmentsContainer.style.display = 'block';
        attachmentsDiv.innerHTML = `
            <div class="flex items-center space-x-2 px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md text-sm text-gray-700 dark:text-gray-300">
                <i class="fas fa-paperclip"></i>
                <span>${draft.attachments} attachment${draft.attachments != 1 ? 's' : ''}</span>
            </div>
        `;
    } else {
        attachmentsContainer.style.display = 'none';
    }
    
    // Set edit button to navigate to edit page
    document.getElementById('modalEditBtn').onclick = function() {
        window.location.href = `/drafts/${draftId}/edit`;
    };
    
    // Show modal
    document.getElementById('draftModal').classList.remove('hidden');
}

function closeDraftModal() {
    document.getElementById('draftModal').classList.add('hidden');
}

function editDraft(draftId) {
    window.location.href = `/drafts/${draftId}/edit`;
}

function duplicateDraft(draftId) {
    showLoadingIndicator();
    
    fetch(`/api/duplicate-draft/${draftId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingIndicator();
        if (data.success) {
            showToast('Draft duplicated successfully', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Failed to duplicate draft: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        hideLoadingIndicator();
        showToast('Error duplicating draft', 'error');
    });
}

function deleteDraft(draftId) {
    if (confirm('Are you sure you want to delete this draft?')) {
        showLoadingIndicator();
        
        fetch(`/api/delete-draft/${draftId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingIndicator();
            if (data.success) {
                const draftRow = document.querySelector(`[data-draft-id="${draftId}"]`);
                if (draftRow) {
                    draftRow.remove();
                }
                showToast('Draft deleted successfully', 'success');
                
                // Check if no drafts left
                const remainingDrafts = document.querySelectorAll('.draft-row');
                if (remainingDrafts.length === 0) {
                    location.reload();
                }
            } else {
                showToast('Failed to delete draft: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            hideLoadingIndicator();
            showToast('Error deleting draft', 'error');
        });
    }
}

function showLoadingIndicator() {
    document.getElementById('loadingIndicator').classList.remove('hidden');
}

function hideLoadingIndicator() {
    document.getElementById('loadingIndicator').classList.add('hidden');
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.remove('hidden');
}

function hideError() {
    document.getElementById('errorMessage').classList.add('hidden');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    // Check if click is outside any dropdown
    if (!e.target.closest('.relative')) {
        document.querySelectorAll('[id^="draft-dropdown-"]').forEach(d => {
            d.classList.add('hidden');
            // Reset aria-expanded for all buttons
            const buttonId = d.id.replace('draft-dropdown-', 'options-menu-');
            const button = document.getElementById(buttonId);
            if (button) {
                button.setAttribute('aria-expanded', 'false');
            }
        });
    }
});
</script>
{% endblock %}