{% extends "base.html" %}

{% block title %}Follow-ups - AI Email Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6 pb-4">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Follow-ups</h1>
        <div class="flex items-center space-x-4">
            <button id="refreshBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-sync-alt mr-2"></i>
                Check & Send Now
            </button>
            <button id="manageRulesBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-cogs mr-2"></i>
                Manage Rules
            </button>
            <button id="scheduleFollowUpBtn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-plus mr-2"></i>
                Schedule Follow-up
            </button>
        </div>
    </div>
    
    <!-- Follow-up Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 rounded-lg p-3">
                    <i class="fas fa-clipboard-list text-blue-600 dark:text-blue-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Rules</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.active_rules or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-yellow-100 dark:bg-yellow-900 rounded-lg p-3">
                    <i class="fas fa-clock text-yellow-600 dark:text-yellow-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pending Follow-Ups</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.pending_follow_ups or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-100 dark:bg-green-900 rounded-lg p-3">
                    <i class="fas fa-paper-plane text-green-600 dark:text-green-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Sent Follow-Ups</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.sent_follow_ups or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 dark:bg-purple-900 rounded-lg p-3">
                    <i class="fas fa-reply text-purple-600 dark:text-purple-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Responses Received</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.responses_received or 0 }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Indicator -->
    <div id="statusIndicator" class="hidden mb-4 p-3 rounded-md bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="statusMessage">Follow-up sent successfully</span>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="glass rounded-xl p-1 mb-6 neumorphic">
        <div class="flex space-x-1">
            <button class="followup-tab px-4 py-2 text-sm font-medium rounded-md bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300" data-tab="followups">
                Follow-Ups
            </button>
            <button class="followup-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-tab="rules">
                Rules
            </button>
            <button class="followup-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-tab="logs">
                Activity Log
            </button>
        </div>
    </div>
    
    <!-- Follow-ups Tab Content -->
    <div id="followups-tab" class="tab-content">
        <!-- Filter Options -->
        <div class="glass rounded-xl p-4 mb-6 neumorphic">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex space-x-1">
                    <button class="filter-tab px-3 py-1.5 text-sm font-medium rounded-md bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300" data-filter="all">
                        All
                    </button>
                    <button class="filter-tab px-3 py-1.5 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-filter="pending">
                        Pending
                    </button>
                    <button class="filter-tab px-3 py-1.5 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-filter="sent">
                        Sent
                    </button>
                    <button class="filter-tab px-3 py-1.5 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-filter="overdue">
                        Overdue
                    </button>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="pauseAllBtn" class="px-3 py-1.5 text-sm font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <i class="fas fa-pause mr-1"></i> Pause All
                    </button>
                    <button id="exportFollowupsBtn" class="px-3 py-1.5 text-sm font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <i class="fas fa-download mr-1"></i> Export
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Follow-ups List -->
        <div class="glass rounded-xl overflow-hidden neumorphic">
            <div class="overflow-y-auto max-h-96">
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% if followups and followups|length > 0 %}
                        {% for followup in followups %}
                        <div class="followup-row flex items-start px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150" data-followup-id="{{ followup.id }}" data-status="{{ 'sent' if followup.status == 'sent' else 'pending' if followup.scheduled_at > now else 'overdue' }}">
                            <div class="flex items-start space-x-3 w-full">
                                <div class="flex-shrink-0">
                                    <div class="h-10 w-10 rounded-full 
                                        {% if followup.status == 'sent' %}bg-green-100 dark:bg-green-900
                                        {% elif followup.scheduled_at > now %}bg-blue-100 dark:bg-blue-900
                                        {% else %}bg-red-100 dark:bg-red-900{% endif %} 
                                        flex items-center justify-center">
                                        <i class="fas 
                                            {% if followup.status == 'sent' %}fa-check text-green-600 dark:text-green-400
                                            {% elif followup.scheduled_at > now %}fa-clock text-blue-600 dark:text-blue-400
                                            {% else %}fa-exclamation-triangle text-red-600 dark:text-red-400{% endif %}"></i>
                                    </div>
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                {% if followup.email %}
                                                    Follow-up for: {{ followup.email.subject }}
                                                {% elif followup.follow_up_rule_id %}
                                                    Rule: {{ followup.rule.name if followup.rule else 'Unknown Rule' }}
                                                {% else %}
                                                    Standalone Follow-up
                                                {% endif %}
                                            </p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                                To: {{ followup.recipient_email }}
                                                {% if followup.sequence_number and followup.sequence_number > 1 %}
                                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                                                    {{ followup.sequence_number }}{{ ordinal(followup.sequence_number) }} follow-up
                                                </span>
                                                {% endif %}
                                            </p>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                                {% if followup.status == 'sent' %}
                                                    Sent {{ followup.sent_at.strftime('%b %d, %Y %I:%M %p') if followup.sent_at else '' }}
                                                {% else %}
                                                    Scheduled {{ followup.scheduled_at.strftime('%b %d, %Y %I:%M %p') if followup.scheduled_at else '' }}
                                                {% endif %}
                                            </span>
                                            
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium 
                                                {% if followup.status == 'sent' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                                {% elif followup.scheduled_at > now %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                                {% else %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{% endif %}">
                                                {% if followup.status == 'sent' %}Sent
                                                {% elif followup.scheduled_at > now %}Pending
                                                {% else %}Overdue{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2 mt-1">
                                        {{ followup.content[:150] if followup.content else '' }}{% if followup.content and followup.content|length > 150 %}...{% endif %}
                                    </p>
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex items-center space-x-2 mt-3">
                                        {% if followup.status not in ['sent', 'completed'] %}
                                        <button onclick="editFollowup({{ followup.id }})" class="px-3 py-1 text-xs font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <i class="fas fa-edit mr-1"></i> Edit
                                        </button>
                                        <button onclick="sendNow({{ followup.id }})" class="px-3 py-1 text-xs font-medium rounded-md border border-transparent text-white bg-indigo-600 hover:bg-indigo-700">
                                            <i class="fas fa-paper-plane mr-1"></i> Send Now
                                        </button>
                                        {% endif %}
                                        <button onclick="testSendFollowup({{ followup.id }})" class="px-3 py-1 text-xs font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <i class="fas fa-vial mr-1"></i> Test Send
                                        </button>
                                        <button onclick="viewFollowup({{ followup.id }})" class="px-3 py-1 text-xs font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <i class="fas fa-eye mr-1"></i> View
                                        </button>
                                        {% if followup.email_id %}
                                        <button onclick="cancelFutureFollowups({{ followup.email_id }})" class="px-3 py-1 text-xs font-medium rounded-md border border-yellow-300 dark:border-yellow-600 text-yellow-700 dark:text-yellow-300 bg-white dark:bg-gray-700 hover:bg-yellow-50 dark:hover:bg-yellow-600">
                                            <i class="fas fa-ban mr-1"></i> Cancel Future
                                        </button>
                                        {% endif %}
                                        <button onclick="deleteFollowup({{ followup.id }})" class="px-3 py-1 text-xs font-medium rounded-md border border-red-300 dark:border-red-600 text-red-700 dark:text-red-300 bg-white dark:bg-gray-700 hover:bg-red-50 dark:hover:bg-red-600">
                                            <i class="fas fa-trash mr-1"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-calendar-check text-5xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No follow-ups scheduled</h3>
                        <p class="text-gray-500 dark:text-gray-400">
                            Schedule follow-ups for important emails to ensure timely responses.
                        </p>
                        <button onclick="openScheduleModal()" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-plus mr-2"></i>
                            Schedule Follow-up
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rules Tab Content -->
    <div id="rules-tab" class="tab-content hidden">
        <div class="glass rounded-xl overflow-hidden neumorphic">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Follow-up Rules</h3>
                <button id="createRuleBtn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-plus mr-2"></i>
                    Create Rule
                </button>
            </div>
            
            <div class="overflow-y-auto max-h-96">
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% if rules and rules|length > 0 %}
                        {% for rule in rules %}
                        <div class="rule-row px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150" data-rule-id="{{ rule.id }}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white">{{ rule.name }}</h4>
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium 
                                            {% if rule.is_active %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                            {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                                            {% if rule.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                                            {{ rule.trigger_type }}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                        Delay: 
                                        {% if rule.delay_hours < 1 %}
                                            {{ (rule.delay_hours * 60)|int }} minutes
                                        {% elif rule.delay_hours < 24 %}
                                            {{ rule.delay_hours|int }} hours
                                        {% else %}
                                            {{ (rule.delay_hours / 24)|int }} days
                                        {% endif %}
                                        | Max attempts: {{ rule.max_count }}
                                        {% if rule.last_triggered %}
                                        | Last triggered: {{ rule.last_triggered.strftime('%b %d, %Y %I:%M %p') }}
                                        {% endif %}
                                    </p>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <div class="relative">
                                        <button id="ruleActionsBtn{{ rule.id }}" class="px-3 py-1 text-xs font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        
                                        <div id="ruleActionsMenu{{ rule.id }}" class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-10">
                                            <div class="py-1">
                                                <button onclick="editRule({{ rule.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-edit mr-2"></i> Edit Rule
                                                </button>
                                                <button onclick="duplicateRule({{ rule.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-copy mr-2"></i> Duplicate Rule
                                                </button>
                                                <button onclick="toggleRule({{ rule.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-{{ 'pause' if rule.is_active else 'play' }} mr-2"></i> {{ 'Deactivate' if rule.is_active else 'Activate' }}
                                                </button>
                                                <button onclick="testRule({{ rule.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-vial mr-2"></i> Test Follow-Up
                                                </button>
                                                <button onclick="viewRuleLogs({{ rule.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-list mr-2"></i> View Triggered Emails
                                                </button>
                                                <button onclick="deleteRule({{ rule.id }})" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                    <i class="fas fa-trash mr-2"></i> Delete Rule
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-cogs text-5xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No follow-up rules configured</h3>
                        <p class="text-gray-500 dark:text-gray-400">
                            Create rules to automatically send follow-ups based on specific conditions.
                        </p>
                        <button onclick="openCreateRuleModal()" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-plus mr-2"></i>
                            Create Rule
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Logs Tab Content -->
    <div id="logs-tab" class="tab-content hidden">
        <div class="glass rounded-xl overflow-hidden neumorphic">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Follow-up Activity Log</h3>
                <button id="exportLogsBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-download mr-2"></i>
                    Export Logs
                </button>
            </div>
            
            <div class="overflow-y-auto max-h-96">
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% if logs and logs|length > 0 %}
                        {% for log in logs %}
                        <div class="log-row px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0">
                                    <div class="h-8 w-8 rounded-full 
                                        {% if log.status.value == 'Sent' %}bg-green-100 dark:bg-green-900
                                        {% elif log.status.value == 'Pending' %}bg-blue-100 dark:bg-blue-900
                                        {% elif log.status.value == 'Failed' %}bg-red-100 dark:bg-red-900
                                        {% elif log.status.value == 'Skipped' %}bg-yellow-100 dark:bg-yellow-900
                                        {% else %}bg-purple-100 dark:bg-purple-900{% endif %} 
                                        flex items-center justify-center">
                                        <i class="fas 
                                            {% if log.status.value == 'Sent' %}fa-check text-green-600 dark:text-green-400 text-xs
                                            {% elif log.status.value == 'Pending' %}fa-clock text-blue-600 dark:text-blue-400 text-xs
                                            {% elif log.status.value == 'Failed' %}fa-exclamation-triangle text-red-600 dark:text-red-400 text-xs
                                            {% elif log.status.value == 'Skipped' %}fa-forward text-yellow-600 dark:text-yellow-400 text-xs
                                            {% else %}fa-reply text-purple-600 dark:text-purple-400 text-xs{% endif %}"></i>
                                    </div>
                                </div>
                                
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                {{ log.rule.name if log.rule else 'Unknown Rule' }}
                                                <span class="ml-2 text-xs text-gray-500 dark:text-gray-400">
                                                    #{{ log.follow_up_number }} follow-up
                                                </span>
                                            </p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                                To: {{ log.recipient_email }}
                                                {% if log.reason %}
                                                | Reason: {{ log.reason }}
                                                {% endif %}
                                            </p>
                                        </div>
                                        
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-500 dark:text-gray-400">
                                                {{ log.created_at.strftime('%b %d, %Y %I:%M %p') }}
                                            </span>
                                            
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium 
                                                {% if log.status.value == 'Sent' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                                {% elif log.status.value == 'Pending' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                                {% elif log.status.value == 'Failed' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                                {% elif log.status.value == 'Skipped' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                                {% else %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200{% endif %}">
                                                {{ log.status.value }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 mt-2">
                                        <button onclick="viewLogDetails({{ log.id }})" class="px-2 py-1 text-xs font-medium rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <i class="fas fa-eye mr-1"></i> View
                                        </button>
                                        {% if log.status.value == 'Failed' %}
                                        <button onclick="retryFailedFollowup({{ log.follow_up_id }})" class="px-2 py-1 text-xs font-medium rounded border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <i class="fas fa-redo mr-1"></i> Retry
                                        </button>
                                        {% endif %}
                                        {% if log.status.value != 'Replied' %}
                                        <button onclick="cancelFutureFollowups({{ log.original_email_id }})" class="px-2 py-1 text-xs font-medium rounded border border-yellow-300 dark:border-yellow-600 text-yellow-700 dark:text-yellow-300 bg-white dark:bg-gray-700 hover:bg-yellow-50 dark:hover:bg-yellow-600">
                                            <i class="fas fa-ban mr-1"></i> Cancel Future
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-12">
                        <i class="fas fa-list text-5xl text-gray-400 dark:text-gray-600 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No follow-up activity</h3>
                        <p class="text-gray-500 dark:text-gray-400">
                            Follow-up activity will appear here once rules are triggered and follow-ups are sent.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Follow-up Modal -->
<div id="scheduleModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="scheduleForm">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Schedule Follow-up</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Multiple Email Input -->
                        <div>
                            <label for="recipientEmails" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enter Recipient Emails</label>
                            <input 
                                type="text" 
                                id="recipientEmails" 
                                name="recipient_emails" 
                                placeholder="Enter email addresses (comma-separated or one per line)"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            >
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter multiple emails separated by commas or new lines</p>
                        </div>
                        
                        <div>
                            <label for="scheduledDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Scheduled Date</label>
                            <input type="datetime-local" id="scheduledDate" name="scheduled_date" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label for="followupContent" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Follow-up Message</label>
                            <textarea id="followupContent" name="content" rows="4" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter your follow-up message..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Schedule Follow-up
                    </button>
                    <button type="button" onclick="closeScheduleModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create/Edit Rule Modal -->
<div id="ruleModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="ruleModalTitle">Create Follow-up Rule</h3>
                </div>
                
                <form id="ruleForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Basic Information -->
                        <div class="col-span-2">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Basic Information</h4>
                        </div>
                        
                        <div>
                            <label for="ruleName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rule Name</label>
                            <input type="text" id="ruleName" name="name" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label for="ruleStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Status</label>
                            <select id="ruleStatus" name="is_active" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                        
                        <div class="col-span-2">
                            <label for="ruleApplyTo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Apply To</label>
                            <select id="ruleApplyTo" name="apply_to_all" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="true">All outgoing emails</option>
                                <option value="false">Specific recipients</option>
                            </select>
                        </div>
                        
                        <div id="specificRecipientsDiv" class="col-span-2 hidden">
                            <label for="specificRecipients" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Specific Recipients</label>
                            <textarea id="specificRecipients" name="recipient_emails" rows="2" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter email addresses (one per line)"></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter one email address per line</p>
                        </div>
                        
                        <!-- Trigger Conditions -->
                        <div class="col-span-2 mt-4">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Trigger Conditions</h4>
                        </div>
                        
                        <div>
                            <label for="triggerType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Trigger Type</label>
                            <select id="triggerType" name="trigger_type" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="No Reply">No Reply</option>
                                <option value="No Open">No Open</option>
                                <option value="No Click">No Click</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="delayHours" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Delay Value</label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="number" id="delayHours" name="delay_hours" min="1" required class="flex-1 border-gray-300 dark:border-gray-600 rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <select id="delayUnit" name="delay_unit" class="border-gray-300 dark:border-gray-600 rounded-r-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="minutes">Minutes</option>
                                    <option value="hours">Hours</option>
                                    <option value="days">Days</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="maxAttempts" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Max Attempts</label>
                            <input type="number" id="maxAttempts" name="max_count" min="1" max="10" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div class="col-span-2">
                            <div class="flex items-center">
                                <input id="stopOnReply" name="stop_on_reply" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="stopOnReply" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                    Stop follow-ups if recipient replies
                                </label>
                            </div>
                        </div>
                        
                        <!-- Follow-up Sequence -->
                        <div class="col-span-2 mt-4">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Follow-up Sequence</h4>
                        </div>
                        
                        <div class="col-span-2">
                            <div id="sequenceContainer" class="space-y-4">
                                <!-- Sequence items will be added here dynamically -->
                            </div>
                            
                            <button type="button" id="addSequenceBtn" class="mt-2 px-3 py-1.5 text-sm font-medium rounded-md border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <i class="fas fa-plus mr-1"></i> Add Follow-up Step
                            </button>
                        </div>
                        
                        <!-- Message Generation -->
                        <div class="col-span-2 mt-4">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Message Generation</h4>
                        </div>
                        
                        <div class="col-span-2">
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input id="templateBased" name="message_type" value="Template-Based" type="radio" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" checked>
                                    <label for="templateBased" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                        Template-Based
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input id="aiGenerated" name="message_type" value="AI-Generated" type="radio" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                    <label for="aiGenerated" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                        AI-Generated
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="templateOptions" class="col-span-2">
                            <label for="templateText" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Template Text</label>
                            <textarea id="templateText" name="template_text" rows="4" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter your follow-up template..."></textarea>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Available placeholders: {{recipient_name}}, {{previous_subject}}, {{days_since_last_email}}</p>
                        </div>
                        
                        <div id="aiOptions" class="col-span-2 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="aiTone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tone</label>
                                    <select id="aiTone" name="ai_tone" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="Professional">Professional</option>
                                        <option value="Friendly">Friendly</option>
                                        <option value="Polite">Polite</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="aiLength" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Length</label>
                                    <select id="aiLength" name="ai_length" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="Short">Short</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Detailed">Detailed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Safety & Controls -->
                        <div class="col-span-2 mt-4">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-2">Safety & Controls</h4>
                        </div>
                        
                        <div class="col-span-2">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="sendWindowStart" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Send Window Start</label>
                                    <input type="time" id="sendWindowStart" name="send_window_start" value="09:00" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                
                                <div>
                                    <label for="sendWindowEnd" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Send Window End</label>
                                    <input type="time" id="sendWindowEnd" name="send_window_end" value="18:00" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-span-2">
                            <div class="flex items-center">
                                <input id="businessDaysOnly" name="business_days_only" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                                <label for="businessDaysOnly" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                    Send only on business days
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="saveRuleBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Save Rule
                </button>
                <button type="button" onclick="closeRuleModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Rule Modal -->
<div id="testRuleModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Test Follow-up Rule</h3>
                </div>
                
                <form id="testRuleForm">
                    <div class="space-y-4">
                        <div>
                            <label for="testEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Test Email Address</label>
                            <input type="email" id="testEmail" name="test_email" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Enter your email address to receive the test">
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="sendTestRule()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Send Test
                </button>
                <button type="button" onclick="closeTestRuleModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // GSAP animations
    if (typeof gsap !== 'undefined') {
        gsap.from(".followup-row", {
            duration: 0.5,
            x: -20,
            opacity: 0,
            stagger: 0.05,
            ease: "power2.out"
        });
    }
    
    // Tab functionality
    const tabs = document.querySelectorAll('.followup-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Update tab styles
            tabs.forEach(t => {
                t.classList.remove('bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-700', 'dark:text-indigo-300');
                t.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            this.classList.add('bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-700', 'dark:text-indigo-300');
            this.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            // Show/hide tab content
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        });
    });
    
    // Filter tabs for follow-ups
    const filterTabs = document.querySelectorAll('.filter-tab');
    const followups = document.querySelectorAll('.followup-row');
    
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const filter = this.dataset.filter;
            
            // Update tab styles
            filterTabs.forEach(t => {
                t.classList.remove('bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-700', 'dark:text-indigo-300');
                t.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            this.classList.add('bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-700', 'dark:text-indigo-300');
            this.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            // Filter followups
            followups.forEach(followup => {
                if (filter === 'all' || followup.dataset.status === filter) {
                    followup.style.display = 'flex';
                } else {
                    followup.style.display = 'none';
                }
            });
        });
    });
    
    // Rule actions dropdowns
    document.querySelectorAll('[id^="ruleActionsBtn"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const ruleId = this.id.replace('ruleActionsBtn', '');
            const menu = document.getElementById(`ruleActionsMenu${ruleId}`);
            
            // Close all other menus
            document.querySelectorAll('[id^="ruleActionsMenu"]').forEach(m => {
                if (m.id !== `ruleActionsMenu${ruleId}`) {
                    m.classList.add('hidden');
                }
            });
            
            // Toggle this menu
            menu.classList.toggle('hidden');
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function() {
        document.querySelectorAll('[id^="ruleActionsMenu"]').forEach(menu => {
            menu.classList.add('hidden');
        });
    });
    
    // Schedule follow-up button
    document.getElementById('scheduleFollowUpBtn').addEventListener('click', function() {
        openScheduleModal();
    });
    
    // Manage rules button
    document.getElementById('manageRulesBtn').addEventListener('click', function() {
        // Switch to rules tab
        document.querySelector('[data-tab="rules"]').click();
    });
    
    // Create rule button
    document.getElementById('createRuleBtn').addEventListener('click', function() {
        openCreateRuleModal();
    });
    
    // Add sequence button
    document.getElementById('addSequenceBtn').addEventListener('click', function() {
        addSequenceItem();
    });
    
    // Apply to radio buttons
    document.getElementById('ruleApplyTo').addEventListener('change', function() {
        const specificRecipientsDiv = document.getElementById('specificRecipientsDiv');
        if (this.value === 'false') {
            specificRecipientsDiv.classList.remove('hidden');
        } else {
            specificRecipientsDiv.classList.add('hidden');
        }
    });
    
    // Message type radio buttons
    document.querySelectorAll('input[name="message_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const templateOptions = document.getElementById('templateOptions');
            const aiOptions = document.getElementById('aiOptions');
            
            if (this.value === 'Template-Based') {
                templateOptions.classList.remove('hidden');
                aiOptions.classList.add('hidden');
            } else {
                templateOptions.classList.add('hidden');
                aiOptions.classList.remove('hidden');
            }
        });
    });
    
    // Schedule form
    document.getElementById('scheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form values directly
        const recipientEmails = document.getElementById('recipientEmails').value;
        const scheduledDate = document.getElementById('scheduledDate').value;
        const content = document.getElementById('followupContent').value;
        
        // Validate form data
        if (!recipientEmails || recipientEmails.trim() === '') {
            showToast('Please enter at least one recipient email', 'error');
            return;
        }
        
        if (!scheduledDate) {
            showToast('Please select a scheduled date', 'error');
            return;
        }
        
        if (!content || content.trim() === '') {
            showToast('Please enter a follow-up message', 'error');
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('recipient_emails', recipientEmails);
        formData.append('scheduled_date', scheduledDate);
        formData.append('content', content);
        
        fetch('/email/schedule-followup', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Follow-up scheduled successfully', 'success');
                closeScheduleModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(`Failed to schedule follow-up: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error scheduling follow-up', 'error');
        });
    });
    
    // Refresh functionality
    document.getElementById('refreshBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        fetch('/email/check-followups', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Follow-ups checked and sent if due', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Error checking follow-ups', 'error');
            }
            icon.classList.remove('fa-spin');
        })
        .catch(error => {
            showToast('Error checking follow-ups', 'error');
            icon.classList.remove('fa-spin');
        });
    });
    
    // Pause all button
    document.getElementById('pauseAllBtn').addEventListener('click', function() {
        const isPausing = this.textContent.includes('Pause');
        const action = isPausing ? 'pause' : 'resume';
        const endpoint = `/api/follow-up/${action}-all`;
        
        fetch(endpoint, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                this.innerHTML = `<i class="fas fa-play mr-1"></i> Resume All`;
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(`Failed to ${action} all follow-ups: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showToast(`Error ${action}ing all follow-ups`, 'error');
        });
    });
    
    // Export follow-ups button
    document.getElementById('exportFollowupsBtn').addEventListener('click', function() {
        window.location.href = '/api/follow-up/export-logs';
    });
    
    // Export logs button
    document.getElementById('exportLogsBtn').addEventListener('click', function() {
        window.location.href = '/api/follow-up/export-logs';
    });
    
    // Set minimum date to current datetime
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('scheduledDate').min = localDateTime;
    
    // Initialize with one sequence item
    addSequenceItem();
    
    // Save Rule button event listener - FIXED
    document.getElementById('saveRuleBtn').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        saveRule();
    });
});

function addSequenceItem() {
    const container = document.getElementById('sequenceContainer');
    const sequenceCount = container.children.length + 1;
    
    const sequenceItem = document.createElement('div');
    sequenceItem.className = 'border border-gray-200 dark:border-gray-700 rounded-md p-4';
    sequenceItem.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <h5 class="text-sm font-medium text-gray-900 dark:text-white">Follow-up #${sequenceCount}</h5>
            ${sequenceCount > 1 ? '<button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300"><i class="fas fa-trash"></i></button>' : ''}
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Delay (days)</label>
                <input type="number" name="sequence_delay" min="1" value="${sequenceCount * 3}" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Subject (optional)</label>
                <input type="text" name="sequence_subject" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Message</label>
                <textarea name="sequence_message" rows="3" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
            </div>
        </div>
        <input type="hidden" name="sequence_number" value="${sequenceCount}">
    `;
    
    container.appendChild(sequenceItem);
}

function openScheduleModal() {
    document.getElementById('scheduleModal').classList.remove('hidden');
    if (typeof gsap !== 'undefined') {
        gsap.from("#scheduleModal .bg-white", {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "power2.out"
        });
    }
}

function closeScheduleModal() {
    if (typeof gsap !== 'undefined') {
        gsap.to("#scheduleModal .bg-white", {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "power2.in",
            onComplete: function() {
                document.getElementById('scheduleModal').classList.add('hidden');
            }
        });
    } else {
        document.getElementById('scheduleModal').classList.add('hidden');
    }
}

function openCreateRuleModal() {
    document.getElementById('ruleModalTitle').textContent = 'Create Follow-up Rule';
    document.getElementById('ruleForm').reset();
    document.getElementById('specificRecipientsDiv').classList.add('hidden');
    document.getElementById('aiOptions').classList.add('hidden');
    document.getElementById('templateOptions').classList.remove('hidden');
    
    // Reset sequence container
    document.getElementById('sequenceContainer').innerHTML = '';
    addSequenceItem();
    
    document.getElementById('ruleModal').classList.remove('hidden');
    
    if (typeof gsap !== 'undefined') {
        gsap.from("#ruleModal .bg-white", {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "power2.out"
        });
    }
}

function closeRuleModal() {
    if (typeof gsap !== 'undefined') {
        gsap.to("#ruleModal .bg-white", {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "power2.in",
            onComplete: function() {
                document.getElementById('ruleModal').classList.add('hidden');
            }
        });
    } else {
        document.getElementById('ruleModal').classList.add('hidden');
    }
}

function saveRule() {
    const form = document.getElementById('ruleForm');
    
    // Collect form data with only valid fields for FollowUpRule model
    const ruleData = {
        name: document.getElementById('ruleName').value,
        is_active: document.getElementById('ruleStatus').value === 'true',
        apply_to_all: document.getElementById('ruleApplyTo').value === 'true',
        trigger_type: document.getElementById('triggerType').value,
        delay_hours: parseInt(document.getElementById('delayHours').value),
        max_count: parseInt(document.getElementById('maxAttempts').value),
        stop_on_reply: document.getElementById('stopOnReply').checked,
        business_days_only: document.getElementById('businessDaysOnly').checked,
        send_window_start: document.getElementById('sendWindowStart').value,
        send_window_end: document.getElementById('sendWindowEnd').value,
        sequences: []
    };
    
    // Handle message type
    const messageType = document.querySelector('input[name="message_type"]:checked').value;
    ruleData.message_type = messageType;
    
    if (messageType === 'Template-Based') {
        ruleData.template_text = document.getElementById('templateText').value;
    } else {
        ruleData.ai_tone = document.getElementById('aiTone').value;
        ruleData.ai_length = document.getElementById('aiLength').value;
    }
    
    // Handle recipient emails
    if (ruleData.apply_to_all === false) {
        const recipientEmails = document.getElementById('specificRecipients').value
            .split('\n')
            .map(email => email.trim())
            .filter(email => email);
        ruleData.recipient_emails = recipientEmails;
    }
    
    // Collect sequences
    const sequenceItems = document.querySelectorAll('#sequenceContainer > div');
    sequenceItems.forEach((item, index) => {
        const delay = item.querySelector('input[name="sequence_delay"]').value;
        const subject = item.querySelector('input[name="sequence_subject"]').value;
        const message = item.querySelector('textarea[name="sequence_message"]').value;
        
        if (delay) {
            ruleData.sequences.push({
                sequence_number: index + 1,
                delay_days: parseInt(delay),
                subject: subject || '',
                message: message || ''
            });
        }
    });
    
    // Handle delay unit conversion
    const delayUnit = document.getElementById('delayUnit').value;
    if (delayUnit === 'days') {
        ruleData.delay_hours = parseInt(ruleData.delay_hours) * 24;
    } else if (delayUnit === 'minutes') {
        ruleData.delay_hours = parseInt(ruleData.delay_hours) / 60;
    } else if (delayUnit === 'hours') {
        ruleData.delay_hours = parseInt(ruleData.delay_hours);
    }
    
    // Create a clean object with only valid FollowUpRule fields
    const cleanRuleData = {
        name: ruleData.name,
        is_active: ruleData.is_active,
        apply_to_all: ruleData.apply_to_all,
        trigger_type: ruleData.trigger_type,
        delay_hours: ruleData.delay_hours,
        max_count: ruleData.max_count,
        stop_on_reply: ruleData.stop_on_reply,
        business_days_only: ruleData.business_days_only,
        send_window_start: ruleData.send_window_start,
        send_window_end: ruleData.send_window_end,
        message_type: ruleData.message_type,
        sequences: ruleData.sequences
    };
    
    // Add optional fields only if they exist
    if (ruleData.template_text) {
        cleanRuleData.template_text = ruleData.template_text;
    }
    if (ruleData.ai_tone) {
        cleanRuleData.ai_tone = ruleData.ai_tone;
    }
    if (ruleData.ai_length) {
        cleanRuleData.ai_length = ruleData.ai_length;
    }
    if (ruleData.recipient_emails) {
        cleanRuleData.recipient_emails = ruleData.recipient_emails;
    }
    
    // Determine if we're creating or updating
    const ruleId = form.dataset.ruleId;
    const endpoint = ruleId ? `/api/follow-up/update-rule/${ruleId}` : '/api/follow-up/create-rule';
    const method = ruleId ? 'PUT' : 'POST';
    
    console.log('Sending rule data:', cleanRuleData); // Debug log
    
    fetch(endpoint, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(cleanRuleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(ruleId ? 'Rule updated successfully' : 'Rule created successfully', 'success');
            closeRuleModal();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(`Failed to ${ruleId ? 'update' : 'create'} rule: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast(`Error ${ruleId ? 'updating' : 'creating'} rule`, 'error');
    });
}

function editRule(ruleId) {
    fetch(`/api/follow-up/rule/${ruleId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const rule = data.rule;
            const form = document.getElementById('ruleForm');
            
            // Set form data
            document.getElementById('ruleModalTitle').textContent = 'Edit Follow-up Rule';
            form.dataset.ruleId = ruleId;
            
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleStatus').value = rule.is_active.toString();
            document.getElementById('ruleApplyTo').value = rule.apply_to_all.toString();
            
            if (!rule.apply_to_all) {
                document.getElementById('specificRecipientsDiv').classList.remove('hidden');
                if (rule.recipient_emails) {
                    document.getElementById('specificRecipients').value = JSON.parse(rule.recipient_emails).join('\n');
                }
            }
            
            document.getElementById('triggerType').value = rule.trigger_type;
            
            // Set delay value and unit based on delay_hours
            const delayHours = rule.delay_hours;
            let delayValue, delayUnit;
            
            if (delayHours < 1) {
                delayValue = Math.round(delayHours * 60);
                delayUnit = 'minutes';
            } else if (delayHours < 24) {
                delayValue = delayHours;
                delayUnit = 'hours';
            } else {
                delayValue = Math.round(delayHours / 24);
                delayUnit = 'days';
            }
            
            document.getElementById('delayHours').value = delayValue;
            document.getElementById('delayUnit').value = delayUnit;
            
            document.getElementById('maxAttempts').value = rule.max_count;
            document.getElementById('stopOnReply').checked = rule.stop_on_reply;
            document.getElementById('sendWindowStart').value = rule.send_window_start;
            document.getElementById('sendWindowEnd').value = rule.send_window_end;
            document.getElementById('businessDaysOnly').checked = rule.business_days_only;
            
            // Set message type
            if (rule.message_type === 'AI-Generated') {
                document.getElementById('aiGenerated').checked = true;
                document.getElementById('templateOptions').classList.add('hidden');
                document.getElementById('aiOptions').classList.remove('hidden');
                
                if (rule.sequences && rule.sequences.length > 0) {
                    document.getElementById('aiTone').value = rule.sequences[0].tone || 'Professional';
                    document.getElementById('aiLength').value = rule.sequences[0].length || 'Medium';
                }
            } else {
                document.getElementById('templateBased').checked = true;
                document.getElementById('aiOptions').classList.add('hidden');
                document.getElementById('templateOptions').classList.remove('hidden');
                document.getElementById('templateText').value = rule.template_text;
            }
            
            // Load sequences
            document.getElementById('sequenceContainer').innerHTML = '';
            if (rule.sequences && rule.sequences.length > 0) {
                rule.sequences.forEach(seq => {
                    const container = document.getElementById('sequenceContainer');
                    const sequenceItem = document.createElement('div');
                    sequenceItem.className = 'border border-gray-200 dark:border-gray-700 rounded-md p-4';
                    sequenceItem.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-sm font-medium text-gray-900 dark:text-white">Follow-up #${seq.sequence_number}</h5>
                            ${seq.sequence_number > 1 ? '<button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300"><i class="fas fa-trash"></i></button>' : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Delay (days)</label>
                                <input type="number" name="sequence_delay" min="1" value="${seq.delay_days}" required class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Subject (optional)</label>
                                <input type="text" name="sequence_subject" value="${seq.subject || ''}" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Message</label>
                                <textarea name="sequence_message" rows="3" class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">${seq.message || ''}</textarea>
                            </div>
                        </div>
                        <input type="hidden" name="sequence_number" value="${seq.sequence_number}">
                    `;
                    container.appendChild(sequenceItem);
                });
            } else {
                addSequenceItem();
            }
            
            document.getElementById('ruleModal').classList.remove('hidden');
            
            if (typeof gsap !== 'undefined') {
                gsap.from("#ruleModal .bg-white", {
                    duration: 0.3,
                    scale: 0.9,
                    opacity: 0,
                    ease: "power2.out"
                });
            }
        } else {
            showToast('Failed to load rule', 'error');
        }
    })
    .catch(error => {
        showToast('Error loading rule', 'error');
    });
}

function duplicateRule(ruleId) {
    fetch(`/api/follow-up/duplicate-rule/${ruleId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Rule duplicated successfully', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(`Failed to duplicate rule: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast('Error duplicating rule', 'error');
    });
}

function toggleRule(ruleId) {
    fetch(`/api/follow-up/toggle-rule/${ruleId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Rule ${data.rule.is_active ? 'activated' : 'deactivated'} successfully`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(`Failed to toggle rule: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast('Error toggling rule', 'error');
    });
}

function deleteRule(ruleId) {
    if (confirm('Are you sure you want to delete this rule? This action cannot be undone.')) {
        fetch(`/api/follow-up/delete-rule/${ruleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Rule deleted successfully', 'success');
                document.querySelector(`[data-rule-id="${ruleId}"]`).remove();
                
                // Check if no rules left
                const remainingRules = document.querySelectorAll('.rule-row');
                if (remainingRules.length === 0) {
                    location.reload();
                }
            } else {
                showToast(`Failed to delete rule: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error deleting rule', 'error');
        });
    }
}

function testRule(ruleId) {
    currentTestRuleId = ruleId;
    document.getElementById('testRuleModal').classList.remove('hidden');
    
    if (typeof gsap !== 'undefined') {
        gsap.from("#testRuleModal .bg-white", {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "power2.out"
        });
    }
}

function closeTestRuleModal() {
    if (typeof gsap !== 'undefined') {
        gsap.to("#testRuleModal .bg-white", {
            duration: 0.3,
            scale: 0.9,
            opacity: 0,
            ease: "power2.in",
            onComplete: function() {
                document.getElementById('testRuleModal').classList.add('hidden');
            }
        });
    } else {
        document.getElementById('testRuleModal').classList.add('hidden');
    }
}

function sendTestRule() {
    const testEmail = document.getElementById('testEmail').value;
    
    if (!testEmail) {
        showToast('Please enter a test email address', 'error');
        return;
    }
    
    fetch(`/api/follow-up/test/${currentTestRuleId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            test_email: testEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Test email sent successfully', 'success');
            closeTestRuleModal();
        } else {
            showToast(`Failed to send test email: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showToast('Error sending test email', 'error');
    });
}

function viewRuleLogs(ruleId) {
    // Switch to logs tab and filter by this rule
    document.querySelector('[data-tab="logs"]').click();
    
    // In a real implementation, you would filter the logs by rule ID
    // For now, we'll just show all logs
}

function viewLogDetails(logId) {
    // In a real implementation, you would fetch and display log details
    showToast('Log details feature coming soon', 'info');
}

function retryFailedFollowup(followupId) {
    if (confirm('Are you sure you want to retry this failed follow-up?')) {
        fetch(`/email/send-followup/${followupId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Follow-up sent successfully', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Failed to send follow-up', 'error');
            }
        })
        .catch(error => {
            showToast('Error sending follow-up', 'error');
        });
    }
}

function cancelFutureFollowups(emailId) {
    if (confirm('Are you sure you want to cancel all future follow-ups for this email?')) {
        fetch(`/api/follow-up/cancel/${emailId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(`Failed to cancel follow-ups: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            showToast('Error cancelling follow-ups', 'error');
        });
    }
}

function editFollowup(followupId) {
    // Open edit modal with current follow-up data
    fetch(`/email/followup/${followupId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Populate form with existing data
            document.getElementById('recipientEmails').value = data.recipient_email || data.email_sender || '';
            document.getElementById('scheduledDate').value = data.scheduled_date;
            document.getElementById('followupContent').value = data.content;
            
            openScheduleModal();
        } else {
            showToast('Failed to load follow-up', 'error');
        }
    })
    .catch(error => {
        showToast('Error loading follow-up', 'error');
    });
}

function sendNow(followupId) {
    if (confirm('Are you sure you want to send this follow-up now?')) {
        fetch(`/email/send-followup/${followupId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Follow-up sent successfully', 'success');
                showStatusIndicator(`Follow-up #${followupId} sent successfully`);
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showToast('Failed to send follow-up', 'error');
            }
        })
        .catch(error => {
            showToast('Error sending follow-up', 'error');
        });
    }
}

function testSendFollowup(followupId) {
    if (confirm('Are you sure you want to test send this follow-up now?')) {
        fetch(`/email/test-send-followup/${followupId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Test follow-up sent successfully', 'success');
                showStatusIndicator(`Test follow-up #${followupId} sent successfully`);
            } else {
                showToast('Failed to send test follow-up', 'error');
            }
        })
        .catch(error => {
            showToast('Error sending test follow-up', 'error');
        });
    }
}

function viewFollowup(followupId) {
    // Open modal with follow-up details
    fetch(`/email/followup/${followupId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFollowupModal(data);
        } else {
            showToast('Failed to load follow-up details', 'error');
        }
    })
    .catch(error => {
        showToast('Error loading follow-up details', 'error');
    });
}

function deleteFollowup(followupId) {
    if (confirm('Are you sure you want to delete this follow-up?')) {
        fetch(`/email/delete-followup/${followupId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-followup-id="${followupId}"]`).remove();
                showToast('Follow-up deleted successfully', 'success');
                showStatusIndicator(`Follow-up #${followupId} deleted successfully`);
                
                // Check if no followups left
                const remainingFollowups = document.querySelectorAll('.followup-row');
                if (remainingFollowups.length === 0) {
                    location.reload();
                }
            } else {
                showToast('Failed to delete follow-up', 'error');
            }
        })
        .catch(error => {
            showToast('Error deleting follow-up', 'error');
        });
    }
}

function showFollowupModal(data) {
    // Create modal HTML
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 overflow-y-auto';
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Follow-up Details</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Original Email</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${data.email_subject || 'Standalone Follow-up'}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Recipient</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${data.recipient_email || data.email_sender || 'Unknown'}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Scheduled Date</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${new Date(data.scheduled_date).toLocaleString()}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${data.status || 'Unknown'}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Message</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">${data.content || ''}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="this.closest('.fixed').remove()" class="w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast
    const toast = document.createElement('div');
    
    // Set toast class based on type
    let bgColorClass = 'bg-blue-500';
    if (type === 'success') bgColorClass = 'bg-green-500';
    else if (type === 'error') bgColorClass = 'bg-red-500';
    else if (type === 'warning') bgColorClass = 'bg-yellow-500';
    
    toast.className = `${bgColorClass} text-white px-4 py-3 rounded-md shadow-lg transform transition-all duration-300 translate-x-full`;
    toast.textContent = message;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
        toast.classList.add('translate-x-0');
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('translate-x-0');
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

function showStatusIndicator(message) {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusMessage = document.getElementById('statusMessage');
    
    statusMessage.textContent = message;
    statusIndicator.classList.remove('hidden');
    
    // Hide the indicator after 10 seconds
    setTimeout(() => {
        statusIndicator.classList.add('hidden');
    }, 10000);
}

// Helper function to get ordinal suffix
function ordinal(n) {
    const s = ["th", "st", "nd", "rd"];
    const v = n % 100;
    return s[(v - 20) % 10] || s[v] || s[0];
}

// Global variable for test rule ID
let currentTestRuleId = null;
</script>
{% endblock %}