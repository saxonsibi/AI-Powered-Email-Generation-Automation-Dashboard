{% extends "base.html" %}

{% block title %}Email Classifications - AI Email Dashboard{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-6 pb-4">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Email Classifications</h1>
        <div class="flex items-center space-x-4">
            <button id="fetchAndClassifyAllBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-download mr-2"></i>
                Fetch & Classify Gmail
            </button>
            <button id="autoClassifyNewBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-sync mr-2"></i>
                Auto-Classify New
            </button>
            <button id="reclassifyAllBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-sync-alt mr-2"></i>
                Reclassify All
            </button>
            <button id="exportBtn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-download mr-2"></i>
                Export
            </button>
        </div>
    </div>
    
    <!-- Classification Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-red-100 dark:bg-red-900 rounded-lg p-3">
                    <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Urgent</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="urgent-count">{{ stats.urgent or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-yellow-100 dark:bg-yellow-900 rounded-lg p-3">
                    <i class="fas fa-star text-yellow-600 dark:text-yellow-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Important</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="important-count">{{ stats.important or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 rounded-lg p-3">
                    <i class="fas fa-briefcase text-blue-600 dark:text-blue-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Work</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="work-count">{{ stats.work or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-100 dark:bg-green-900 rounded-lg p-3">
                    <i class="fas fa-user text-green-600 dark:text-green-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Personal</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="personal-count">{{ stats.personal or 0 }}</p>
                </div>
            </div>
        </div>
        
        <div class="glass rounded-xl p-4 neumorphic">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 dark:bg-purple-900 rounded-lg p-3">
                    <i class="fas fa-shield-alt text-purple-600 dark:text-purple-400"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Spam</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="spam-count">{{ stats.spam or 0 }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Tabs -->
    <div class="glass rounded-xl p-4 mb-6 neumorphic relative z-10">
        <div class="flex flex-wrap space-x-1">
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300" data-category="all">
                All (<span id="total-count">{{ total_emails or 0 }}</span>)
            </button>
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-category="urgent">
                Urgent (<span id="urgent-tab-count">{{ stats.urgent or 0 }}</span>)
            </button>
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-category="important">
                Important (<span id="important-tab-count">{{ stats.important or 0 }}</span>)
            </button>
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-category="work">
                Work (<span id="work-tab-count">{{ stats.work or 0 }}</span>)
            </button>
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-category="personal">
                Personal (<span id="personal-tab-count">{{ stats.personal or 0 }}</span>)
            </button>
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-category="spam">
                Spam (<span id="spam-tab-count">{{ stats.spam or 0 }}</span>)
            </button>
            <button class="classification-tab px-4 py-2 text-sm font-medium rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300" data-category="unclassified">
                Unclassified (<span id="unclassified-count">{{ stats.unclassified or 0 }}</span>)
            </button>
        </div>
    </div>
    
    <!-- Pagination Controls -->
    <div class="flex justify-between items-center mb-4">
        <div class="text-sm text-gray-700 dark:text-gray-300">
            Showing <span id="showing-from">1</span> to <span id="showing-to">50</span> of <span id="total-emails">{{ total_emails or 0 }}</span> emails
        </div>
        <div class="flex space-x-2">
            <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <select id="pageSizeSelect" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700">
                <option value="25">25 per page</option>
                <option value="50" selected>50 per page</option>
                <option value="100">100 per page</option>
            </select>
            <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Classified Emails List -->
    <div class="glass rounded-xl overflow-hidden neumorphic relative">
        <div class="overflow-y-auto" style="max-height: 600px;">
            <div class="divide-y divide-gray-200 dark:divide-gray-700" id="emails-container">
                {% if classifications and classifications|length > 0 %}
                    {% for item in classifications %}
                    {% set email = item.email if item.email else item[0] %}
                    {% set classification = item.classification if item.classification else item[1] %}
                    {% set category = item.category if item.category else item[2] %}
                    <div class="email-row flex items-start px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150 relative" 
                         data-email-id="{{ email.id }}" 
                         data-category="{{ category.name if category else 'unclassified' }}">
                        <div class="flex items-start space-x-3 w-full">
                            <div class="flex-shrink-0">
                                {% if email.sender %}
                                    <img class="h-10 w-10 rounded-full" 
                                         src="https://picsum.photos/seed/{{ email.sender }}/200/200.jpg" 
                                         alt="{{ email.sender }}"
                                         loading="lazy">
                                {% else %}
                                    <div class="h-10 w-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                                        <i class="fas fa-user text-gray-500 dark:text-gray-400"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">
                                            {% if email.sender %}
                                                {{ email.sender.split('@')[0] }}
                                            {% else %}
                                                Unknown Sender
                                            {% endif %}
                                        </p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            {{ email.subject }}
                                        </p>
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 relative">
                                        <span class="text-sm text-gray-500 dark:text-gray-400">
                                            {{ email.received_at.strftime('%b %d, %Y %I:%M %p') if email.received_at else '' }}
                                        </span>
                                        
                                        <span class="category-badge inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium 
                                            {% if category and category.name == 'urgent' %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                                            {% elif category and category.name == 'important' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                                            {% elif category and category.name == 'work' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                                            {% elif category and category.name == 'personal' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                                            {% elif category and category.name == 'spam' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200
                                            {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200{% endif %}">
                                            {{ (category.name if category else 'Unclassified').title() }}
                                        </span>
                                        
                                        <div class="relative inline-block text-left">
                                            <button class="p-1 text-gray-400 hover:text-gray-500" onclick="toggleClassificationDropdown({{ email.id }})">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <div id="classification-dropdown-{{ email.id }}" class="hidden absolute right-0 -top-2 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-50 transform -translate-y-full">
                                                <div class="py-1">
                                                    <button onclick="reclassifyEmail({{ email.id }}, 'urgent')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                        <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i> Mark as Urgent
                                                    </button>
                                                    <button onclick="reclassifyEmail({{ email.id }}, 'important')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                        <i class="fas fa-star mr-2 text-yellow-500"></i> Mark as Important
                                                    </button>
                                                    <button onclick="reclassifyEmail({{ email.id }}, 'work')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                        <i class="fas fa-briefcase mr-2 text-blue-500"></i> Mark as Work
                                                    </button>
                                                    <button onclick="reclassifyEmail({{ email.id }}, 'personal')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                        <i class="fas fa-user mr-2 text-green-500"></i> Mark as Personal
                                                    </button>
                                                    <button onclick="reclassifyEmail({{ email.id }}, 'spam')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                        <i class="fas fa-shield-alt mr-2 text-purple-500"></i> Mark as Spam
                                                    </button>
                                                    <button onclick="viewClassificationDetails({{ email.id }})" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                                        <i class="fas fa-info-circle mr-2"></i> View Details
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2 mt-1">
                                    {{ email.snippet[:150] if email.snippet else '' }}{% if email.snippet and email.snippet|length > 150 %}...{% endif %}
                                </p>
                                
                                {% if classification and classification.confidence_score %}
                                <div class="mt-2">
                                    <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                        <span>AI Confidence:</span>
                                        <div class="ml-2 flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                            <div class="bg-indigo-600 h-2 rounded-full" style="width: {{ classification.confidence_score * 100 }}%"></div>
                                        </div>
                                        <span class="ml-2">{{ (classification.confidence_score * 100)|round }}%</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-12" id="no-emails-message">
                    <i class="fas fa-tags text-5xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No classified emails</h3>
                    <p class="text-gray-500 dark:text-gray-400">
                        Emails will be automatically classified by AI as they arrive.
                        <br>
                        Click "Fetch & Classify Gmail" to fetch and classify all your emails.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Count emails by category on page load
    countEmailsByCategory();
    
    // GSAP animations
    if (typeof gsap !== 'undefined') {
        gsap.from(".email-row", {
            duration: 0.5,
            x: -20,
            opacity: 0,
            stagger: 0.05,
            ease: "power2.out"
        });
    }
    
    // Pagination variables
    let currentPage = 1;
    let pageSize = 50;
    let totalEmails = {{ total_emails or 0 }};
    let currentCategory = 'all';
    
    // Store all email rows for pagination
    const allEmailRows = Array.from(document.querySelectorAll('.email-row'));
    let filteredEmailRows = [...allEmailRows];
    
    // Initialize pagination
    updatePagination();
    
    // Tab functionality
    const tabs = document.querySelectorAll('.classification-tab');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const category = this.dataset.category;
            currentCategory = category;
            
            // Update tab styles
            tabs.forEach(t => {
                t.classList.remove('bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-700', 'dark:text-indigo-300');
                t.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            this.classList.add('bg-indigo-100', 'dark:bg-indigo-900', 'text-indigo-700', 'dark:text-indigo-300');
            this.classList.remove('text-gray-500', 'dark:text-gray-400');
            
            // Filter emails
            filterEmailsByCategory(category);
        });
    });
    
    // Function to filter emails by category
    function filterEmailsByCategory(category) {
        filteredEmailRows = allEmailRows.filter(email => {
            const emailCategory = (email.dataset.category || '').toLowerCase();
            return category === 'all' || emailCategory === category.toLowerCase();
        });
        
        // Reset to first page when filtering
        currentPage = 1;
        
        // Update pagination
        updatePagination();
        
        // Show "no emails" message if needed
        const noEmailsMessage = document.getElementById('no-emails-message');
        if (filteredEmailRows.length === 0 && noEmailsMessage) {
            noEmailsMessage.style.display = 'block';
            // Update message based on selected category
            const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
            noEmailsMessage.querySelector('h3').textContent = `No ${categoryName.toLowerCase()} emails`;
        } else if (noEmailsMessage) {
            noEmailsMessage.style.display = 'none';
        }
    }
    
    // Page size change handler
    document.getElementById('pageSizeSelect').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        updatePagination();
    });
    
    // Previous page handler
    document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updatePagination();
        }
    });
    
    // Next page handler
    document.getElementById('nextPageBtn').addEventListener('click', function() {
        const totalPages = Math.ceil(filteredEmailRows.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            updatePagination();
        }
    });
    
    // Function to update pagination
    function updatePagination() {
        // Hide all email rows
        allEmailRows.forEach(email => {
            email.style.display = 'none';
        });
        
        // Calculate start and end indices
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, filteredEmailRows.length);
        
        // Show only the emails for the current page
        for (let i = startIndex; i < endIndex; i++) {
            filteredEmailRows[i].style.display = 'flex';
        }
        
        // Update pagination info
        const from = filteredEmailRows.length > 0 ? startIndex + 1 : 0;
        const to = endIndex;
        
        document.getElementById('showing-from').textContent = from;
        document.getElementById('showing-to').textContent = to;
        document.getElementById('total-emails').textContent = filteredEmailRows.length;
        
        // Update pagination buttons
        const totalPages = Math.ceil(filteredEmailRows.length / pageSize);
        document.getElementById('prevPageBtn').disabled = currentPage === 1;
        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages || totalPages === 0;
        
        // Re-apply animations if needed
        if (typeof gsap !== 'undefined') {
            gsap.from(".email-row[style*='flex']", {
                duration: 0.3,
                x: -20,
                opacity: 0,
                stagger: 0.02,
                ease: "power2.out"
            });
        }
    }
    
    // Fetch and Classify All Gmail Emails
    document.getElementById('fetchAndClassifyAllBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        // Show loading message
        const emailsContainer = document.getElementById('emails-container');
        const originalContent = emailsContainer.innerHTML;
        emailsContainer.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-5xl text-indigo-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Fetching and classifying emails...</h3>
                <p class="text-gray-500 dark:text-gray-400">
                    Please wait while we fetch and classify your emails from Gmail.
                </p>
            </div>
        `;
        
        fetch('/api/classify-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrf_token')
            },
            body: JSON.stringify({
                fetch_from_gmail: true
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast(`Successfully fetched and classified ${data.count} emails`, 'success');
                // Reload the page to show updated classifications
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('Failed to fetch and classify emails: ' + (data.message || 'Unknown error'), 'error');
                // Restore original content
                emailsContainer.innerHTML = originalContent;
            }
        })
        .catch(error => {
            showToast('Error fetching and classifying emails: ' + error.message, 'error');
            console.error('Error:', error);
            // Restore original content
            emailsContainer.innerHTML = originalContent;
        })
        .finally(() => {
            icon.classList.remove('fa-spin');
        });
    });
    
    // Auto-Classify New Emails
    document.getElementById('autoClassifyNewBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        // Show loading message
        const emailsContainer = document.getElementById('emails-container');
        const originalContent = emailsContainer.innerHTML;
        emailsContainer.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-5xl text-indigo-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Classifying new emails...</h3>
                <p class="text-gray-500 dark:text-gray-400">
                    Please wait while we classify your new emails.
                </p>
            </div>
        `;
        
        fetch('/api/classify-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrf_token')
            },
            body: JSON.stringify({
                fetch_new: true
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast(`Successfully classified ${data.count} new emails`, 'success');
                // Reload the page to show updated classifications
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('Failed to classify new emails: ' + (data.message || 'Unknown error'), 'error');
                // Restore original content
                emailsContainer.innerHTML = originalContent;
            }
        })
        .catch(error => {
            showToast('Error classifying new emails: ' + error.message, 'error');
            console.error('Error:', error);
            // Restore original content
            emailsContainer.innerHTML = originalContent;
        })
        .finally(() => {
            icon.classList.remove('fa-spin');
        });
    });
    
    // Reclassify all
    document.getElementById('reclassifyAllBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        // Show loading message
        const emailsContainer = document.getElementById('emails-container');
        const originalContent = emailsContainer.innerHTML;
        emailsContainer.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-5xl text-indigo-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Reclassifying emails...</h3>
                <p class="text-gray-500 dark:text-gray-400">
                    Please wait while we reclassify your emails using AI.
                </p>
            </div>
        `;
        
        fetch('/api/classify-batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrf_token')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showToast(`Successfully reclassified ${data.count} emails`, 'success');
                // Update counts if provided
                if (data.counts) {
                    updateCategoryCounts(data.counts);
                }
                // Reload the page to show updated classifications
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showToast('Failed to reclassify emails: ' + (data.error || 'Unknown error'), 'error');
                // Restore original content
                emailsContainer.innerHTML = originalContent;
            }
        })
        .catch(error => {
            showToast('Error reclassifying emails: ' + error.message, 'error');
            console.error('Error:', error);
            // Restore original content
            emailsContainer.innerHTML = originalContent;
        })
        .finally(() => {
            icon.classList.remove('fa-spin');
        });
    });
    
    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', function() {
        // Create a CSV of the current classifications
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Sender,Subject,Category,Received Date\n";
        
        const emailRows = document.querySelectorAll('.email-row');
        emailRows.forEach(row => {
            const sender = row.querySelector('.text-gray-900').textContent.trim();
            const subject = row.querySelector('.text-gray-500').textContent.trim();
            const category = row.querySelector('.category-badge').textContent.trim();
            const date = row.querySelector('.text-gray-400').textContent.trim();
            
            csvContent += `"${sender}","${subject}","${category}","${date}"\n`;
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "email-classifications.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Classifications exported successfully', 'success');
    });
});

// Function to count emails by category
function countEmailsByCategory() {
    const emailRows = document.querySelectorAll('.email-row');
    const counts = {
        urgent: 0,
        important: 0,
        work: 0,
        personal: 0,
        spam: 0,
        unclassified: 0
    };
    
    emailRows.forEach(email => {
        const category = (email.dataset.category || '').toLowerCase();
        if (counts.hasOwnProperty(category)) {
            counts[category]++;
        }
    });
    
    // Update the counts in the UI
    updateCategoryCounts(counts);
}

function toggleClassificationDropdown(emailId) {
    const dropdown = document.getElementById(`classification-dropdown-${emailId}`);
    
    // Close all other dropdowns
    document.querySelectorAll('[id^="classification-dropdown-"]').forEach(d => {
        if (d.id !== `classification-dropdown-${emailId}`) {
            d.classList.add('hidden');
        }
    });
    
    dropdown.classList.toggle('hidden');
}

function reclassifyEmail(emailId, category) {
    // Show loading state
    const emailRow = document.querySelector(`[data-email-id="${emailId}"]`);
    const badge = emailRow.querySelector('.category-badge');
    const originalBadge = badge.outerHTML;
    
    badge.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Classifying...';
    
    // Make the API call
    fetch(`/api/classify-email/${emailId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrf_token')
        },
        body: JSON.stringify({
            category: category,
            manual_override: true
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast('Email reclassified successfully', 'success');
            
            // Update the UI
            emailRow.dataset.category = category;
            
            // Update the category badge
            const newBadge = document.createElement('span');
            newBadge.className = `category-badge inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                category === 'urgent' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                category === 'important' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                category === 'work' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' :
                category === 'personal' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                category === 'spam' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' :
                'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200'
            }`;
            newBadge.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            
            badge.replaceWith(newBadge);
            
            // Recount emails by category to update counts
            countEmailsByCategory();
        } else {
            showToast('Failed to reclassify email: ' + (data.error || 'Unknown error'), 'error');
            // Restore original badge
            badge.outerHTML = originalBadge;
        }
    })
    .catch(error => {
        showToast('Error reclassifying email: ' + error.message, 'error');
        console.error('Error:', error);
        // Restore original badge
        badge.outerHTML = originalBadge;
    });
}

function viewClassificationDetails(emailId) {
    // Show a simple modal with email details since the API endpoint doesn't exist
    const emailRow = document.querySelector(`[data-email-id="${emailId}"]`);
    const sender = emailRow.querySelector('.text-gray-900').textContent.trim();
    const subject = emailRow.querySelector('.text-gray-500').textContent.trim();
    const category = emailRow.querySelector('.category-badge').textContent.trim();
    const date = emailRow.querySelector('.text-gray-400').textContent.trim();
    
    // Create modal HTML
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 overflow-y-auto';
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Email Details</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Sender</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${sender}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Subject</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${subject}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Category</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${category}</p>
                        </div>
                        
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Received Date</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${date}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="this.closest('.fixed').remove()" class="w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function updateCategoryCounts(counts) {
    // Update the counts in the UI
    if (counts) {
        const categories = ['urgent', 'important', 'work', 'personal', 'spam'];
        let total = 0;
        
        categories.forEach(category => {
            const count = counts[category] || 0;
            total += count;
            
            // Update main count
            const countElement = document.getElementById(`${category}-count`);
            if (countElement) {
                countElement.textContent = count;
            }
            
            // Update tab count
            const tabCountElement = document.getElementById(`${category}-tab-count`);
            if (tabCountElement) {
                tabCountElement.textContent = count;
            }
        });
        
        // Update total count
        const totalCountElement = document.getElementById('total-count');
        if (totalCountElement) {
            totalCountElement.textContent = total;
        }
        
        // Update unclassified count
        const unclassifiedCount = counts.unclassified || 0;
        const unclassifiedCountElement = document.getElementById('unclassified-count');
        if (unclassifiedCountElement) {
            unclassifiedCountElement.textContent = unclassifiedCount;
        }
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Helper function to show toast notifications
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 transform transition-all duration-300 translate-y-full opacity-0`;
    
    // Set color based on type
    if (type === 'success') {
        toast.classList.add('bg-green-500', 'text-white');
        toast.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
    } else if (type === 'error') {
        toast.classList.add('bg-red-500', 'text-white');
        toast.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
    } else {
        toast.classList.add('bg-blue-500', 'text-white');
        toast.innerHTML = `<i class="fas fa-info-circle"></i><span>${message}</span>`;
    }
    
    // Add to document
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative') && !e.target.closest('.inline-block')) {
        document.querySelectorAll('[id^="classification-dropdown-"]').forEach(d => {
            d.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}